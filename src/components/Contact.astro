---
// --- IMPORTS ---
import { getI18N } from '../i18n/utils';
import { SOCIAL_LINKS } from '../consts';

// --- INITIAL CONFIGURATION ---
const i18n = getI18N({ astroUrl: Astro.url });
const titleId = "contact-title";
const formStatusMessages = i18n.contact.status;
---

<!-- CONTACT SECTION -->
<section id="contact" class="py-20 px-4 bg-gray-800 fade-in-section" aria-labelledby={titleId}>
    <div class="container mx-auto max-w-2xl text-center">
        <h2 id={titleId} class="text-3xl md:text-4xl font-bold mb-4" set:html={i18n.contact.title} />
        <p class="text-gray-400 mb-8">
            {i18n.contact.subtitle}
        </p>

        <!-- CONTACT FORM -->
        <form
            id="contact-form"
            name="contact" 
            method="POST"
            data-netlify="true"
            netlify-honeypot="bot-field"
            class="text-left space-y-4"
            data-msg-success={formStatusMessages.success}
            data-msg-error={formStatusMessages.error}
            data-msg-sending={formStatusMessages.sending}
        >
            <input type="hidden" name="form-name" value="contact" />

            <p class="hidden">
                <label>Don't fill this out if you're human: <input name="bot-field" /></label>
            </p>

            <!-- Name Field -->
            <div>
                <label for="name" class="sr-only">{i18n.contact.name}</label>
                <input type="text" id="name" name="name" autocomplete="given-name" required placeholder={i18n.contact.name} class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Surname Field -->
            <div>
                <label for="surname" class="sr-only">{i18n.contact.surname}</label>
                <input type="text" id="surname" name="surname" autocomplete="family-name" required placeholder={i18n.contact.surname} class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Email Field -->
            <div>
                <label for="email" class="sr-only">{i18n.contact.email}</label>
                <input type="email" id="email" name="email" autocomplete="email" required placeholder={i18n.contact.email} class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Phone Field -->
            <div>
                <label for="phone" class="sr-only">{i18n.contact.phone}</label>
                <input type="tel" id="phone" name="phone" autocomplete="tel" placeholder={i18n.contact.phone} class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- Subject Dropdown -->
            <div class="relative">
                <label for="subject" class="sr-only">{i18n.contact.subject.label}</label>
                
                <!-- SELECT HIDDEN FOR VALIDATION -->
                <select 
                    id="subject" 
                    name="subject" 
                    required 
                    class="absolute opacity-0 pointer-events-none -z-10 bottom-0 left-0 h-0 w-0"
                    tabindex="-1"
                    aria-hidden="true"
                >
                    <option value="" disabled selected hidden>{i18n.contact.subject.placeholder}</option>
                    <option value="Proposta di Lavoro">{i18n.contact.subject.option1}</option>
                    <option value="Richiesta Informazioni">{i18n.contact.subject.option2}</option>
                    <option value="Altro">{i18n.contact.subject.option3}</option>
                </select>

                <!-- CUSTOM SELECT -->
                <div class="relative" id="custom-select-container">
                    <button 
                        type="button" 
                        id="custom-select-trigger"
                        class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition text-left flex justify-between items-center text-gray-400"
                    >
                        <span id="custom-select-value">{i18n.contact.subject.placeholder}</span>
                        <svg class="h-5 w-5 fill-current transition-transform duration-300" id="custom-select-arrow" viewBox="0 0 20 20">
                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                        </svg>
                    </button>

                    <ul 
                        id="custom-select-options" 
                        class="absolute z-50 w-full mt-2 bg-gray-800 border border-gray-600 rounded-lg shadow-xl opacity-0 invisible transform -translate-y-2 transition-all duration-200 overflow-hidden"
                    >
                        <li data-value="Proposta di Lavoro" class="px-4 py-3 hover:bg-blue-600 hover:text-white cursor-pointer text-gray-300 transition-colors border-b border-gray-700 last:border-0">
                            {i18n.contact.subject.option1}
                        </li>
                        <li data-value="Richiesta Informazioni" class="px-4 py-3 hover:bg-blue-600 hover:text-white cursor-pointer text-gray-300 transition-colors border-b border-gray-700 last:border-0">
                            {i18n.contact.subject.option2}
                        </li>
                        <li data-value="Altro" class="px-4 py-3 hover:bg-blue-600 hover:text-white cursor-pointer text-gray-300 transition-colors">
                            {i18n.contact.subject.option3}
                        </li>
                    </ul>
                </div>
            </div>            

            <!-- Message Textarea -->
            <div>
                <label for="message" class="sr-only">{i18n.contact.message}</label>
                <textarea id="message" name="message" rows="5" required placeholder={i18n.contact.message} class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"></textarea>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button id="contact-submit" type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900 focus-visible:ring-blue-500">
                    {i18n.contact.button}
                </button>
            </div>
        </form>

        <!-- Status Message Container -->
        <div id="form-status" class="mt-4 text-lg" role="alert"></div>

        <div class="mt-12 text-center">
            <p class="text-gray-400 mb-2">{i18n.contact.alternative}:</p>
            <div class="flex justify-center gap-6">
                <a href={SOCIAL_LINKS.linkedin} target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 font-semibold transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded-sm">LinkedIn</a>
                <a href={SOCIAL_LINKS.email} class="text-blue-400 hover:text-blue-300 font-semibold transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded-sm">Email</a>
            </div>
        </div>
    </div>
</section>

<!-- CLIENT-SIDE FORM HANDLING -->
<script>
    // DOM Elements
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const statusDiv = document.getElementById('form-status');
    const submitButton = document.getElementById('contact-submit') as HTMLButtonElement;
    
    // Custom Select Elements
    const trigger = document.getElementById('custom-select-trigger');
    const options = document.getElementById('custom-select-options');
    const arrow = document.getElementById('custom-select-arrow');
    const displayValue = document.getElementById('custom-select-value');
    const nativeSelect = document.getElementById('subject') as HTMLSelectElement;

    // --- CUSTOM SELECT LOGIC ---
    if (trigger && options && nativeSelect) {
        const toggleMenu = (show: boolean) => {
            options.classList.toggle('invisible', !show);
            options.classList.toggle('opacity-0', !show);
            options.classList.toggle('-translate-y-2', !show);
            options.classList.toggle('opacity-100', show);
            options.classList.toggle('translate-y-0', show);
            arrow?.classList.toggle('rotate-180', show);
        };

        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu(options.classList.contains('invisible'));
        });

        options.querySelectorAll('li').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const target = e.target as HTMLElement;

                nativeSelect.value = target.getAttribute('data-value') || '';
                if (displayValue) {
                    displayValue.textContent = target.textContent?.trim() || '';
                    displayValue.classList.replace('text-gray-400', 'text-white');
                }
                toggleMenu(false);
            });
        });

        document.addEventListener('click', (e) => {
            if (!trigger.contains(e.target as Node)) toggleMenu(false);
        });
    }

    // --- FORM SUBMISSION LOGIC (AJAX) ---
    const showMsg = (msg: string, color: string) => {
        if (!statusDiv) return;
        statusDiv.textContent = msg;
        statusDiv.style.color = color;
        setTimeout(() => { if (statusDiv.textContent === msg) statusDiv.textContent = ''; }, 5000);
    };

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const target = e.target as HTMLFormElement;
            
            if (submitButton) submitButton.disabled = true;
            showMsg(target.dataset.msgSending || '...', '#9ca3af');

            try {
                const res = await fetch("/", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams(new FormData(target) as any).toString(),
                });

                if (res.ok) {
                    // @ts-ignore
                    window.dataLayer = window.dataLayer || [];
                    // @ts-ignore
                    window.dataLayer.push({
                        'event': 'form_submission_success',
                        'module': 'contact_form'
                    });
                    showMsg(target.dataset.msgSuccess || 'OK', '#34d399');
                    target.reset();
                    if (displayValue) {
                        displayValue.textContent = nativeSelect.options[0].text;
                        displayValue.classList.replace('text-white', 'text-gray-400');
                    }
                } else {
                    throw new Error();
                }
            } catch (err) {
                showMsg(target.dataset.msgError || 'Error', '#f87171');
            } finally {
                if (submitButton) submitButton.disabled = false;
            }
        });
    }
</script>

<style>
    select:invalid {
        color: #9ca3af;
    }
</style>